version: '3.8'

services:
  gateway:
    build: 
      context: .
      dockerfile: gateway/Dockerfile
    container_name: omg-roma-gateway
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=production
      - PLUGINS_DIR=/app/plugins
      - CONFIG_DIR=/app/config
    volumes:
      - omg_roma_config:/app/config
      - omg_roma_plugins:/app/plugins
    # Gateway starts first (no dependencies)
    # Provides centralized services for plugins
    networks:
      - omg-roma-network
    restart: unless-stopped
    # Gateway starts first and provides centralized services
    labels:
      - "traefik.enable=false"

  youtube-plugin:
    build: 
      context: .
      dockerfile: plugins/youtube/Dockerfile
    container_name: omg-youtube-plugin
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - CONFIG_FILE=/app/config.json
      - GATEWAY_URL=http://gateway:3100
    networks:
      - omg-roma-network
    restart: unless-stopped
    # Plugin starts after gateway (simple dependency)
    depends_on:
      - gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  omg-roma-network:
    driver: bridge
    name: omg-roma-network

volumes:
  omg_roma_config:
    driver: local
  omg_roma_plugins:
    driver: local  
  omg_roma_youtube_config:
    driver: local

# Note per Portainer:
# 1. Assicurati che il repository abbia la struttura corretta
# 2. Usa questo file come docker-compose.yml nella root
# 3. I volumi sono managed da Docker (non bind mounts)
# 4. Per la configurazione iniziale, accedi via exec ai container
